-- =====================================================
-- NoticeGate 공지관리 시스템 DDL
-- DBMS    : PostgreSQL 15.15
-- 작성자  : 함윤식
-- 버전    : v1.2
-- =====================================================

BEGIN;

-- =====================================================
-- 1. NOTICE_BASE (공지 기본)
-- =====================================================
CREATE TABLE NOTICE_BASE (
    NOTICE_ID            BIGSERIAL PRIMARY KEY,
    TITLE                VARCHAR(200) NOT NULL,
    CONTENT              TEXT NOT NULL,
    NOTICE_LEVEL         VARCHAR(10) NOT NULL,
    NOTICE_STATUS        VARCHAR(30) NOT NULL,
    SENDER_ORG_UNIT_ID   VARCHAR(50),
    SENDER_ORG_UNIT_NAME VARCHAR(100),
    PUBLISH_START_AT     TIMESTAMP,
    PUBLISH_END_AT       TIMESTAMP,
    IS_MAINTENANCE       BOOLEAN NOT NULL DEFAULT FALSE,
    IS_COMPLETED         BOOLEAN NOT NULL DEFAULT FALSE,
    COMPLETED_AT         TIMESTAMP,
    MAIL_SUBJECT         VARCHAR(300),
    CREATED_AT           TIMESTAMP NOT NULL DEFAULT NOW(),
    CREATED_BY           VARCHAR(50) NOT NULL,
    UPDATED_AT           TIMESTAMP NOT NULL DEFAULT NOW(),
    UPDATED_BY           VARCHAR(50) NOT NULL
);

COMMENT ON TABLE NOTICE_BASE IS '공지 기본 정보';

COMMENT ON COLUMN NOTICE_BASE.NOTICE_ID IS '공지 고유 식별자(PK)';
COMMENT ON COLUMN NOTICE_BASE.TITLE IS '공지 제목';
COMMENT ON COLUMN NOTICE_BASE.CONTENT IS '공지 상세 내용';
COMMENT ON COLUMN NOTICE_BASE.NOTICE_LEVEL IS '공지 중요도 (L1:일반, L2:중요, L3:긴급)';
COMMENT ON COLUMN NOTICE_BASE.NOTICE_STATUS IS '공지 상태 (DRAFT, PENDING, APPROVED, SENT, FAILED, COMPLETED)';
COMMENT ON COLUMN NOTICE_BASE.SENDER_ORG_UNIT_ID IS '공지 발신 부서 ID';
COMMENT ON COLUMN NOTICE_BASE.SENDER_ORG_UNIT_NAME IS '공지 발신 부서명';
COMMENT ON COLUMN NOTICE_BASE.PUBLISH_START_AT IS '공지 게시 시작 일시';
COMMENT ON COLUMN NOTICE_BASE.PUBLISH_END_AT IS '공지 게시 종료 일시';
COMMENT ON COLUMN NOTICE_BASE.IS_MAINTENANCE IS '시스템 점검/장애 공지 여부';
COMMENT ON COLUMN NOTICE_BASE.IS_COMPLETED IS '공지 완료 처리 여부';
COMMENT ON COLUMN NOTICE_BASE.COMPLETED_AT IS '공지 완료 처리 일시';
COMMENT ON COLUMN NOTICE_BASE.MAIL_SUBJECT IS '메일 및 캘린더 일정 제목';
COMMENT ON COLUMN NOTICE_BASE.CREATED_AT IS '공지 등록 일시';
COMMENT ON COLUMN NOTICE_BASE.CREATED_BY IS '공지 등록자';
COMMENT ON COLUMN NOTICE_BASE.UPDATED_AT IS '공지 수정 일시';
COMMENT ON COLUMN NOTICE_BASE.UPDATED_BY IS '공지 수정자';

-- =====================================================
-- 2. NOTICE_APPROVAL (공지 승인)
-- =====================================================
CREATE TABLE NOTICE_APPROVAL (
    APPROVAL_ID        BIGSERIAL PRIMARY KEY,
    NOTICE_ID          BIGINT NOT NULL UNIQUE,
    APPROVAL_STATUS    VARCHAR(20) NOT NULL,
    APPROVER_USER_ID   VARCHAR(50),
    APPROVER_NAME      VARCHAR(100),
    REQUESTED_AT       TIMESTAMP NOT NULL DEFAULT NOW(),
    DECIDED_AT         TIMESTAMP,
    REJECT_REASON      VARCHAR(500),
    CONSTRAINT FK_NOTICE_APPROVAL
        FOREIGN KEY (NOTICE_ID)
        REFERENCES NOTICE_BASE (NOTICE_ID)
        ON DELETE CASCADE
);

COMMENT ON TABLE NOTICE_APPROVAL IS '공지 승인 정보';

COMMENT ON COLUMN NOTICE_APPROVAL.APPROVAL_ID IS '승인 고유 식별자(PK)';
COMMENT ON COLUMN NOTICE_APPROVAL.NOTICE_ID IS '승인 대상 공지 ID';
COMMENT ON COLUMN NOTICE_APPROVAL.APPROVAL_STATUS IS '승인 상태 (PENDING, APPROVED, REJECTED)';
COMMENT ON COLUMN NOTICE_APPROVAL.APPROVER_USER_ID IS '승인자 사용자 ID';
COMMENT ON COLUMN NOTICE_APPROVAL.APPROVER_NAME IS '승인자 이름';
COMMENT ON COLUMN NOTICE_APPROVAL.REQUESTED_AT IS '승인 요청 일시';
COMMENT ON COLUMN NOTICE_APPROVAL.DECIDED_AT IS '승인 또는 반려 처리 일시';
COMMENT ON COLUMN NOTICE_APPROVAL.REJECT_REASON IS '반려 사유';

-- =====================================================
-- 3. NOTICE_SEND_PLAN (공지 발송 계획)
-- =====================================================
CREATE TABLE NOTICE_SEND_PLAN (
    SEND_PLAN_ID        BIGSERIAL PRIMARY KEY,
    NOTICE_ID           BIGINT NOT NULL UNIQUE,
    SEND_MODE           VARCHAR(20) NOT NULL,
    SCHEDULED_SEND_AT   TIMESTAMP,
    BUNDLE_KEY          VARCHAR(80),
    ALLOW_BUNDLE        BOOLEAN NOT NULL DEFAULT TRUE,
    CONSTRAINT FK_NOTICE_SEND_PLAN
        FOREIGN KEY (NOTICE_ID)
        REFERENCES NOTICE_BASE (NOTICE_ID)
        ON DELETE CASCADE
);

COMMENT ON TABLE NOTICE_SEND_PLAN IS '공지 발송 계획 정보';

COMMENT ON COLUMN NOTICE_SEND_PLAN.SEND_PLAN_ID IS '발송 계획 고유 식별자(PK)';
COMMENT ON COLUMN NOTICE_SEND_PLAN.NOTICE_ID IS '발송 대상 공지 ID';
COMMENT ON COLUMN NOTICE_SEND_PLAN.SEND_MODE IS '발송 방식 (IMMEDIATE:즉시, SCHEDULED:예약)';
COMMENT ON COLUMN NOTICE_SEND_PLAN.SCHEDULED_SEND_AT IS '예약 발송 일시';
COMMENT ON COLUMN NOTICE_SEND_PLAN.BUNDLE_KEY IS '공지 묶음 발송 기준 키';
COMMENT ON COLUMN NOTICE_SEND_PLAN.ALLOW_BUNDLE IS '공지 묶음 발송 허용 여부';

-- =====================================================
-- 4. NOTICE_DELIVERY_LOG (공지 발송 이력)
-- =====================================================
CREATE TABLE NOTICE_DELIVERY_LOG (
    DELIVERY_ID         BIGSERIAL PRIMARY KEY,
    NOTICE_ID           BIGINT NOT NULL,
    CHANNEL             VARCHAR(30) NOT NULL DEFAULT 'OUTLOOK_MAIL',
    DELIVERY_STATUS     VARCHAR(20) NOT NULL,
    SENT_AT             TIMESTAMP,
    ATTEMPT_COUNT       INT NOT NULL DEFAULT 0,
    LAST_ERROR          TEXT,
    PROVIDER_MESSAGE_ID VARCHAR(120),
    IDEMPOTENCY_KEY     VARCHAR(80),
    CONSTRAINT FK_NOTICE_DELIVERY
        FOREIGN KEY (NOTICE_ID)
        REFERENCES NOTICE_BASE (NOTICE_ID)
        ON DELETE CASCADE
);

COMMENT ON TABLE NOTICE_DELIVERY_LOG IS '공지 발송 처리 이력';

COMMENT ON COLUMN NOTICE_DELIVERY_LOG.DELIVERY_ID IS '발송 이력 고유 식별자(PK)';
COMMENT ON COLUMN NOTICE_DELIVERY_LOG.NOTICE_ID IS '발송 대상 공지 ID';
COMMENT ON COLUMN NOTICE_DELIVERY_LOG.CHANNEL IS '공지 발송 채널';
COMMENT ON COLUMN NOTICE_DELIVERY_LOG.DELIVERY_STATUS IS '발송 처리 상태 (READY, SENT, FAILED)';
COMMENT ON COLUMN NOTICE_DELIVERY_LOG.SENT_AT IS '발송 완료 일시';
COMMENT ON COLUMN NOTICE_DELIVERY_LOG.ATTEMPT_COUNT IS '발송 시도 횟수';
COMMENT ON COLUMN NOTICE_DELIVERY_LOG.LAST_ERROR IS '최종 발송 오류 내용';
COMMENT ON COLUMN NOTICE_DELIVERY_LOG.PROVIDER_MESSAGE_ID IS '외부 발송 시스템 메시지 ID';
COMMENT ON COLUMN NOTICE_DELIVERY_LOG.IDEMPOTENCY_KEY IS '중복 발송 방지 키';

-- =====================================================
-- 5. NOTICE_CALENDAR_EVENT (공지 캘린더 이벤트)
-- =====================================================
CREATE TABLE NOTICE_CALENDAR_EVENT (
    CALENDAR_EVENT_ID   BIGSERIAL PRIMARY KEY,
    NOTICE_ID           BIGINT NOT NULL,
    RESOURCE_MAILBOX    VARCHAR(120) NOT NULL,
    PROVIDER_EVENT_ID   VARCHAR(120) NOT NULL,
    CREATED_AT          TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT FK_NOTICE_CALENDAR_EVENT
        FOREIGN KEY (NOTICE_ID)
        REFERENCES NOTICE_BASE (NOTICE_ID)
        ON DELETE CASCADE
);

COMMENT ON TABLE NOTICE_CALENDAR_EVENT IS '공지 캘린더 일정 연계 정보';

COMMENT ON COLUMN NOTICE_CALENDAR_EVENT.CALENDAR_EVENT_ID IS '캘린더 이벤트 고유 식별자(PK)';
COMMENT ON COLUMN NOTICE_CALENDAR_EVENT.NOTICE_ID IS '연계 대상 공지 ID';
COMMENT ON COLUMN NOTICE_CALENDAR_EVENT.RESOURCE_MAILBOX IS '공지 자원 메일 주소';
COMMENT ON COLUMN NOTICE_CALENDAR_EVENT.PROVIDER_EVENT_ID IS '외부 캘린더 이벤트 ID';
COMMENT ON COLUMN NOTICE_CALENDAR_EVENT.CREATED_AT IS '캘린더 일정 등록 일시';

-- =====================================================
-- 6. NOTICE_TARGET (공지 수신 대상)
-- =====================================================
CREATE TABLE NOTICE_TARGET (
    TARGET_ID       BIGSERIAL PRIMARY KEY,
    NOTICE_ID       BIGINT NOT NULL,
    TARGET_TYPE     VARCHAR(20) NOT NULL,
    TARGET_KEY      VARCHAR(80) NOT NULL,
    TARGET_NAME     VARCHAR(200),
    CONSTRAINT FK_NOTICE_TARGET
        FOREIGN KEY (NOTICE_ID)
        REFERENCES NOTICE_BASE (NOTICE_ID)
        ON DELETE CASCADE
);

COMMENT ON TABLE NOTICE_TARGET IS '공지 수신 대상 정보';

COMMENT ON COLUMN NOTICE_TARGET.TARGET_ID IS '수신 대상 고유 식별자(PK)';
COMMENT ON COLUMN NOTICE_TARGET.NOTICE_ID IS '공지 ID';
COMMENT ON COLUMN NOTICE_TARGET.TARGET_TYPE IS '수신 대상 유형 (법인/부서/사용자/서비스)';
COMMENT ON COLUMN NOTICE_TARGET.TARGET_KEY IS '수신 대상 식별 키';
COMMENT ON COLUMN NOTICE_TARGET.TARGET_NAME IS '수신 대상 표시명';

-- =====================================================
-- 7. NOTICE_TAG (공지 해시태그)
-- =====================================================
CREATE TABLE NOTICE_TAG (
    TAG_ID      BIGSERIAL PRIMARY KEY,
    NOTICE_ID   BIGINT NOT NULL,
    TAG_VALUE   VARCHAR(50) NOT NULL,
    CONSTRAINT FK_NOTICE_TAG
        FOREIGN KEY (NOTICE_ID)
        REFERENCES NOTICE_BASE (NOTICE_ID)
        ON DELETE CASCADE
);

COMMENT ON TABLE NOTICE_TAG IS '공지 분류용 해시태그';

COMMENT ON COLUMN NOTICE_TAG.TAG_ID IS '해시태그 고유 식별자(PK)';
COMMENT ON COLUMN NOTICE_TAG.NOTICE_ID IS '공지 ID';
COMMENT ON COLUMN NOTICE_TAG.TAG_VALUE IS '해시태그 값';

-- =====================================================
-- 8. NOTICE_ATTACHMENT (공지 첨부 파일)
-- =====================================================
CREATE TABLE NOTICE_ATTACHMENT (
    ATTACHMENT_ID   BIGSERIAL PRIMARY KEY,
    NOTICE_ID       BIGINT NOT NULL,
    FILE_NAME       VARCHAR(255) NOT NULL,
    SIZE_BYTES      BIGINT NOT NULL,
    STORAGE_KEY     VARCHAR(300) NOT NULL,
    CONSTRAINT FK_NOTICE_ATTACHMENT
        FOREIGN KEY (NOTICE_ID)
        REFERENCES NOTICE_BASE (NOTICE_ID)
        ON DELETE CASCADE
);

COMMENT ON TABLE NOTICE_ATTACHMENT IS '공지 첨부 파일 메타데이터';

COMMENT ON COLUMN NOTICE_ATTACHMENT.ATTACHMENT_ID IS '첨부 파일 고유 식별자(PK)';
COMMENT ON COLUMN NOTICE_ATTACHMENT.NOTICE_ID IS '공지 ID';
COMMENT ON COLUMN NOTICE_ATTACHMENT.FILE_NAME IS '첨부 파일명';
COMMENT ON COLUMN NOTICE_ATTACHMENT.SIZE_BYTES IS '첨부 파일 크기(Byte)';
COMMENT ON COLUMN NOTICE_ATTACHMENT.STORAGE_KEY IS '첨부 파일 저장 경로 또는 키';

COMMIT;
