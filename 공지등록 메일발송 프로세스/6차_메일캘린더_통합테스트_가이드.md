#  공지 메일 + 캘린더 통합 테스트 가이드

##  매우 중요!

**현재 코드 상태:**
-  메일: 실제로 발송됨 (모든 사용자에게)
-  캘린더: 실제로 이벤트 생성됨 (Outlook 캘린더에)

**테스트 없이 공지를 등록하면:**
- 모든 수신 대상자에게 메일 발송
- 모든 참석자의 Outlook 캘린더에 이벤트 생성
- 초대 메일 자동 발송

**→ 반드시 테스트 모드로 먼저 테스트!**

---

## 🎯 통합 테스트 모드 설정

### application.yaml 설정

```yaml
notice:
  mail:
    # 메일 테스트 모드
    test-mode: true               # 메일 발송 안함
    
    # 캘린더 테스트 모드
    calendar-test-mode: true      # 캘린더 이벤트 생성 안함
    
    # 화이트리스트 (선택사항)
    whitelist-mode: false
    whitelist-emails:
      - your.email@company.com
```

---

##  4단계 테스트 절차

### 1단계: 완전 안전 테스트 (필수) 

**설정:**
```yaml
notice.mail.test-mode: true
notice.mail.calendar-test-mode: true
```

**테스트:**
1. 공지 등록 (Outlook 캘린더 등록함 선택)
2. 승인
3. 로그 확인

**확인 사항:**
- [ ] 메일 로그 출력됨
- [ ] 캘린더 로그 출력됨
- [ ] 수신자 목록 확인
- [ ] 참석자 목록 확인
- [ ] 메일 내용 확인
- [ ] 이벤트 시간 확인
- [ ] 실제 메일/캘린더는 생성 안됨

**예상 로그:**
```
 [테스트 모드] 메일 발송 정보
 수신자: 15명
...
 실제 메일은 발송되지 않았습니다 

 [캘린더 테스트 모드] Outlook 이벤트 생성 정보
 참석자: 15명
...
 실제 이벤트는 생성되지 않았습니다 
```

---

### 2단계: 본인에게만 메일 테스트

**설정:**
```yaml
notice.mail.test-mode: false
notice.mail.calendar-test-mode: true
notice.mail.whitelist-mode: true
notice.mail.whitelist-emails:
  - your.email@company.com
```

**테스트:**
1. 공지 등록
2. 승인
3. 본인 이메일 확인

**확인 사항:**
- [ ] 본인에게만 메일 도착
- [ ] 메일 제목 확인
- [ ] 메일 내용 확인
- [ ] 첨부파일 다운로드 확인
- [ ] 캘린더는 생성 안됨

---

### 3단계: 본인에게만 캘린더 테스트

**설정:**
```yaml
notice.mail.test-mode: true
notice.mail.calendar-test-mode: false
notice.mail.whitelist-mode: true
notice.mail.whitelist-emails:
  - your.email@company.com
```

**테스트:**
1. 공지 등록 (Outlook 캘린더 등록함)
2. 본인 Outlook 확인

**확인 사항:**
- [ ] 본인 캘린더에 이벤트 생성
- [ ] 초대 메일 도착
- [ ] 이벤트 제목 확인
- [ ] 이벤트 시간 확인
- [ ] 알림 설정 확인
- [ ] 메일은 발송 안됨

---

### 4단계: 실제 운영 전환

**설정:**
```yaml
notice.mail.test-mode: false
notice.mail.calendar-test-mode: false
notice.mail.whitelist-mode: false
```

**확인:**
- [ ] 1~3단계 모두 완료
- [ ] 팀원과 함께 최종 검증
- [ ] 설정 변경 확인
- [ ] 애플리케이션 재시작

---

## 🎨 테스트 조합 매트릭스

| 시나리오 | test-mode | calendar-test-mode | whitelist-mode | 결과 |
|---------|-----------|-------------------|----------------|------|
| **1단계** |  true |  true |  false | 메일, 캘린더 (로그만) |
| **2단계** |  false |  true |  true | 메일(본인만), 캘린더 |
| **3단계** |  true |  false |  true | 메일, 캘린더(본인만) |
| **통합 테스트** |  false |  false |  true | 메일, 캘린더 (본인만) |
| **운영** |  false |  false |  false | 메일, 캘린더 (전체) |

---

## 🔄 전체 흐름도

```
┌────────────────────────────────────────────────────┐
│              공지 등록                              │
│  - 메일 발송 계획                                   │
│  - Outlook 캘린더 등록 (선택)                       │
└───────────────┬────────────────────────────────────┘
                │
                ↓
        ┌───────────────┐
        │   관리자 승인   │
        └───────┬───────┘
                │
        ┌───────┴────────┐
        ↓                ↓
┌──────────────┐  ┌──────────────┐
│ 메일 발송     │  │ 캘린더 생성   │
│ (즉시/예약)   │  │ (즉시)       │
└───┬──────────┘  └───┬──────────┘
    │                 │
    ↓                 ↓
┌──────────────┐  ┌──────────────┐
│ NoticeMailService │  │ OutlookCalendarService │
└───┬──────────┘  └───┬──────────┘
    │                 │
    ↓                 ↓
test-mode 체크    calendar-test-mode 체크
    │                 │
┌───┴───┐         ┌───┴───┐
↓       ↓         ↓       ↓
true   false     true   false
│       │         │       │
로그    실제      로그    실제
출력    발송      출력    생성
```

---

## 📊 기능별 테스트 상태

### 메일 발송
| 기능 | 테스트 가능 | 실제 동작 |
|------|-----------|----------|
| 즉시 발송 |  |  |
| 정기 발송 (09/13/17) |  |  |
| 지정 시간 발송 |  |  |
| 첨부파일 |  |  |
| 묶음 발송 |  |  |

### 캘린더 연동
| 기능 | 테스트 가능 | 실제 동작 |
|------|-----------|----------|
| 이벤트 생성 |  |  |
| 참석자 초대 |  |  |
| 알림 설정 |  |  |
| HTML 본문 |  |  |

---

##  실제 테스트 예시

### 공지 등록 JSON

```json
POST /v1/api/notices
{
  "title": "[테스트] 시스템 점검 안내",
  "content": "2026년 1월 25일 오전 9시부터 10시까지 시스템 점검을 실시합니다.",
  "noticeLevel": "L2",
  "affectedServiceId": 1,
  "targets": [
    {
      "targetType": "ORG_UNIT",
      "targetKey": "123",
      "targetName": "IT부서"
    }
  ],
  "sendPlan": {
    "sendMode": "IMMEDIATE",
    "allowBundle": true
  },
  "outlookCalendar": {
    "register": true,
    "eventDate": "2026-01-25T09:00:00"
  }
}
```

### 1단계 테스트 (안전 모드)

**로그 출력:**
```
 메일 발송 시작: noticeId=1
 [테스트 모드] 메일 발송 정보
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 공지 ID: 1
 공지 제목: [테스트] 시스템 점검 안내
 발신자: admin@company.com
 수신자: 5 명
   ✉️ user1@company.com
   ✉️ user2@company.com
   ✉️ user3@company.com
   ✉️ user4@company.com
   ✉️ user5@company.com
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 [테스트 모드] 실제 메일은 발송되지 않았습니다 
 메일 발송 완료: noticeId=1, recipients=5

 Outlook 캘린더 이벤트 생성: noticeId=1
 [캘린더 테스트 모드] Outlook 이벤트 생성 정보
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 이벤트 제목: [테스트] 시스템 점검 안내
 시작 시간: 2026-01-25 09:00
 종료 시간: 2026-01-25 10:00
 주최자: admin@company.com
 참석자: 5 명
    user1@company.com
    user2@company.com
    user3@company.com
    user4@company.com
    user5@company.com
 알림: 15분 전
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 [캘린더 테스트 모드] 실제 이벤트는 생성되지 않았습니다 
 Outlook 캘린더 이벤트 정보 저장 완료
```

### 2단계 테스트 (본인만 메일)

**설정:**
```yaml
test-mode: false
calendar-test-mode: true
whitelist-mode: true
whitelist-emails: [your.email@company.com]
```

**결과:**
-  본인 메일함에 도착
-  제목: [테스트] 시스템 점검 안내
-  캘린더는 생성 안됨

---

## 🎯 체크리스트

### 배포 전
- [ ] MailTestProperty.java 배치
- [ ] NoticeMailService_WithTestMode.java 배치
- [ ] OutlookCalendarService_WithTestMode.java 배치
- [ ] application.yaml 설정 추가
- [ ] 애플리케이션 재시작

### 테스트
- [ ] 1단계: 완전 안전 모드 (로그 확인)
- [ ] 2단계: 본인에게만 메일
- [ ] 3단계: 본인에게만 캘린더
- [ ] 통합: 본인에게 메일+캘린더
- [ ] 팀원 3명과 소규모 테스트

### 운영 전환
- [ ] 모든 테스트 완료 확인
- [ ] 설정 변경 (test-mode: false)
- [ ] 첫 공지는 본인만 포함해서 테스트
- [ ] 문제 없으면 전체 운영

---

## 💡 추천 설정

### 개발 환경 (application-dev.yaml)
```yaml
notice:
  mail:
    test-mode: true
    calendar-test-mode: true
    whitelist-mode: false
```

### 스테이징 환경 (application-staging.yaml)
```yaml
notice:
  mail:
    test-mode: false
    calendar-test-mode: false
    whitelist-mode: true
    whitelist-emails:
      - qa-team@company.com
      - dev-team@company.com
```

### 운영 환경 (application-prod.yaml)
```yaml
notice:
  mail:
    test-mode: false
    calendar-test-mode: false
    whitelist-mode: false
```

---

## 🆘 문제 해결

### Q: 로그가 안 보여요
```yaml
logging:
  level:
    kr.co.koreazinc.app.service.notice: DEBUG
```

### Q: 테스트 모드인데도 메일이 나갔어요
1. application.yaml 확인
2. 애플리케이션 재시작했는지 확인
3. 로그에서 " [테스트 모드]" 확인

### Q: 캘린더가 생성 안돼요
1. calendar-test-mode 확인
2. outlookCalendar.register: true 확인
3. Graph API 권한 확인 (Calendar.ReadWrite)

### Q: 화이트리스트가 적용 안돼요
1. whitelist-mode: true 확인
2. whitelist-emails에 본인 이메일 확인
3. 이메일 주소 대소문자 확인

---

##  최종 정리

###  테스트 모드 적용됨
- 메일 발송 (즉시/정기/지정시간)
- 캘린더 이벤트 생성
- 첨부파일
- 묶음 발송

###  독립적으로 테스트 가능
- 메일만 테스트
- 캘린더만 테스트
- 메일+캘린더 통합 테스트

###  안전장치
- 로그로 모든 정보 확인
- 화이트리스트로 본인만 테스트
- 단계별 점진적 테스트

---

## 📚 관련 문서

- **메일테스트모드_설정가이드.md**: 메일 테스트 상세 설명
- **캘린더테스트모드_가이드.md**: 캘린더 테스트 상세 설명
- **공지발송_전체흐름_가이드.md**: 발송 모드별 설명
- **파일배치_폴더구조_가이드.md**: 파일 배치 방법

---

이제 안심하고 모든 기능을 테스트하세요! 🎉
