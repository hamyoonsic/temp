<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>공지 발송 & 승인 & 메일/캘린더 흐름 정리</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      margin: 0;
      padding: 24px;
      background-color: #f5f5f7;
      color: #222;
      line-height: 1.6;
    }

    h1, h2, h3 {
      margin-top: 0;
      color: #1f2933;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 16px;
    }

    h2 {
      font-size: 20px;
      margin-top: 32px;
      border-left: 4px solid #4f46e5;
      padding-left: 8px;
    }

    h3 {
      font-size: 16px;
      margin-top: 20px;
    }

    .tagline {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 24px;
    }

    .container {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.2fr);
      gap: 24px;
    }

    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 18px 20px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.05);
      border: 1px solid #e5e7eb;
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: #eef2ff;
      color: #4338ca;
    }

    .section-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    ul, ol {
      padding-left: 18px;
      margin-top: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .code {
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      background: #111827;
      color: #e5e7eb;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .code-block {
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      background: #111827;
      color: #e5e7eb;
      padding: 10px 12px;
      border-radius: 6px;
      overflow-x: auto;
      white-space: pre;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    .flow-box {
      border-radius: 10px;
      border: 1px dashed #c4c4d4;
      padding: 12px;
      background-color: #f9fafb;
      margin-bottom: 12px;
    }

    .flow-header {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #111827;
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 6px;
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background-color: #f3f4f6;
      color: #4b5563;
    }

    .table-like {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }

    .table-like th,
    .table-like td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
      vertical-align: top;
    }

    .table-like th {
      background-color: #f9fafb;
      font-weight: 600;
      white-space: nowrap;
    }

    .highlight {
      color: #9333ea;
      font-weight: 600;
    }

    .footer {
      margin-top: 32px;
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <h1>공지 발송 & 승인 & 메일 · 캘린더 흐름 정리</h1>
  <div class="tagline">
    버전 1: 텍스트 상세 설명 · 버전 2: 한눈에 보는 흐름 다이어그램
  </div>

  <div class="container">
    <!-- 왼쪽: 버전 1 텍스트 상세 -->
    <div class="card">
      <div class="section-label">버전 1</div>
      <div class="card-title">
        텍스트 상세 버전
        <span class="badge">개발자 / 기획 보고용</span>
      </div>

      <h2>1. 공지 등록 단계</h2>

      <h3>1) 컨트롤러 레이어</h3>
      <ul>
        <li><span class="code">NoticeController</span></li>
        <li>엔드포인트 예시: <span class="code">POST /v1/api/notices</span></li>
        <li>주요 동작:
          <ul>
            <li>요청 DTO와 로그인 사용자 정보를 받아서</li>
            <li><span class="code">noticeService.createNotice(dto, userId)</span> 호출</li>
          </ul>
        </li>
      </ul>

      <h3>2) 서비스 레이어</h3>
      <ul>
        <li><span class="code">NoticeService</span></li>
        <li>핵심 메서드: <span class="code">@Transactional createNotice(NoticeRegistrationDto dto, String userId)</span></li>
      </ul>

      <table class="table-like">
        <thead>
          <tr>
            <th>역할</th>
            <th>설명</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>공지 본문 저장</td>
            <td>
              <ul>
                <li><span class="code">NoticeBase</span> 엔티티 생성 및 저장</li>
                <li>초기 상태는 보통 <span class="code">PENDING</span> (승인 대기)</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>발송 계획 저장</td>
            <td>
              <ul>
                <li><span class="code">NoticeSendPlan</span> 생성 및 저장</li>
                <li>즉시 발송: <span class="code">SendMode.IMMEDIATE</span></li>
                <li>예약 발송: <span class="code">SendMode.SCHEDULED</span> + <span class="code">scheduledSendAt</span></li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>첨부파일 처리</td>
            <td>
              <ul>
                <li><span class="code">NoticeAttachmentRepository</span> 를 통해 파일 메타 정보 저장</li>
              </ul>
            </td>
          </tr>
        </tbody>
      </table>

      <h2>2. 승인(결재) 단계</h2>

      <h3>1) 컨트롤러 레이어</h3>
      <ul>
        <li><span class="code">NoticeController</span></li>
        <li>엔드포인트 예시: <span class="code">POST /v1/api/notices/{noticeId}/approve</span></li>
        <li>주요 동작:
          <ul>
            <li><span class="code">noticeService.approveNotice(noticeId, approver)</span> 호출</li>
          </ul>
        </li>
      </ul>

      <h3>2) 서비스 레이어</h3>
      <ul>
        <li><span class="code">NoticeService</span></li>
        <li>핵심 메서드: <span class="code">@Transactional approveNotice(Long noticeId, String approver)</span></li>
      </ul>

      <table class="table-like">
        <thead>
          <tr>
            <th>단계</th>
            <th>처리 내용</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>상태 변경</td>
            <td>
              <ul>
                <li>기존 상태 확인: <span class="code">PENDING</span> 인지 체크</li>
                <li><span class="code">noticeStatus</span> 를 <span class="code">APPROVED</span> 로 변경</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>발송 모드 분기</td>
            <td>
              <ul>
                <li><strong>즉시 발송(IMMEDIATE)</strong>
                  <ul>
                    <li><span class="code">noticeMailService.sendNoticeEmail(noticeId)</span></li>
                    <li>발송 후 해당 <span class="code">NoticeSendPlan</span> 삭제</li>
                  </ul>
                </li>
                <li><strong>예약 발송(SCHEDULED)</strong>
                  <ul>
                    <li>DB에 발송 계획만 유지</li>
                    <li>실제 발송은 스케줄러가 담당</li>
                  </ul>
                </li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>캘린더 등록</td>
            <td>
              <ul>
                <li><span class="code">calendarRegister == true</span> 인 경우에만 실행</li>
                <li><span class="code">OutlookCalendarService.createCalendarEvent(...)</span> 호출</li>
              </ul>
            </td>
          </tr>
        </tbody>
      </table>

      <h2>3. 메일 발송 단계</h2>

      <h3>1) 메일 서비스</h3>
      <ul>
        <li><span class="code">NoticeMailService</span></li>
        <li>핵심 메서드: <span class="code">sendNoticeEmail(Long noticeId)</span></li>
      </ul>

      <table class="table-like">
        <thead>
          <tr>
            <th>역할</th>
            <th>설명</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>데이터 조회</td>
            <td>
              <ul>
                <li>공지 정보: <span class="code">NoticeBaseRepository</span></li>
                <li>수신자 정보: <span class="code">NoticeRecipient</span>, <span class="code">NoticeTarget</span>, <span class="code">UserMaster</span> 등 조합</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>테스트/화이트리스트</td>
            <td>
              <ul>
                <li>테스트 모드 여부에 따라 실제 수신자 제한</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>메일 전송</td>
            <td>
              <ul>
                <li><span class="code">MailInfo</span> 구성 후</li>
                <li><span class="code">MailUtils.sendMail(...)</span> 호출</li>
              </ul>
            </td>
          </tr>
          <tr>
            <td>발송 로그</td>
            <td>
              <ul>
                <li><span class="code">NoticeDeliveryLog</span> 에 성공/실패 결과 기록</li>
              </ul>
            </td>
          </tr>
        </tbody>
      </table>

      <h2>4. 예약 발송 스케줄러</h2>

      <ul>
        <li><span class="code">NoticeMailScheduler</span></li>
        <li><span class="code">@Scheduled</span> 메서드 안에서 동작</li>
      </ul>

      <div class="code-block">
@Scheduled(...)
public void sendScheduledNotices() {
    // 1. 현재 시간 기준으로 발송 시점이 지난 계획 조회
    // 2. APPROVED 인 공지만 실제 메일 발송
    // 3. 성공 시 NoticeSendPlan 삭제
}
      </div>

      <h2>5. 캘린더 등록 (Outlook)</h2>

      <ul>
        <li><span class="code">OutlookCalendarService</span></li>
        <li>핵심 메서드: <span class="code">createCalendarEvent(Long noticeId, LocalDateTime start, LocalDateTime end)</span></li>
        <li>주요 역할:
          <ul>
            <li>제목/본문/참석자 구성</li>
            <li>Graph API 에 <span class="code">/events</span> 생성 요청</li>
            <li>응답받은 <span class="code">eventId</span> 를 <span class="code">NoticeCalendarEvent</span> 로 저장</li>
          </ul>
        </li>
      </ul>
    </div>

    <!-- 오른쪽: 버전 2 한눈에 보는 버전 -->
    <div class="card">
      <div class="section-label">버전 2</div>
      <div class="card-title">
        한눈에 보는 흐름 버전
        <span class="badge">다이어그램 / 요약</span>
      </div>

      <h2>1. 전체 프로세스 개요</h2>

      <div class="flow-box">
        <div class="flow-header">전체 흐름 요약</div>
        <div class="code-block">
[사용자 공지 등록 화면]
          |
          v
[NoticeController.createNotice]
          |
          v
[NoticeService.createNotice]
  - NoticeBase 저장
  - NoticeSendPlan 저장 (IMMEDIATE / SCHEDULED)
          |
          v
------------- 상태: PENDING -------------
          |
   (관리자 승인 버튼 클릭)
          |
          v
[NoticeController.approveNotice]
          |
          v
[NoticeService.approveNotice]
  - 상태 PENDING → APPROVED
  - 발송 모드에 따라 분기
          |
          |---- IMMEDIATE ----> [메일 즉시 발송: NoticeMailService]
          |
          |---- SCHEDULED ----> [발송 시간까지 대기 → Scheduler]
          |
          |---- calendarRegister == true
          v
[OutlookCalendarService.createCalendarEvent]
          |
          v
[캘린더 이벤트 생성 완료]
        </div>
      </div>

      <h2>2. 즉시 발송(IMMEDIATE) 플로우</h2>

      <div class="flow-box">
        <div class="flow-header">승인 시 바로 메일 발송</div>
        <div class="code-block">
[승인 버튼 클릭]
      |
      v
[approveNotice]
      |
      v
SendMode == IMMEDIATE ?
      |
      v
[NoticeMailService.sendNoticeEmail]
      |
      v
[NoticeDeliveryLog 기록 & NoticeSendPlan 삭제]
        </div>
      </div>

      <h2>3. 예약 발송(SCHEDULED) 플로우</h2>

      <div class="flow-box">
        <div class="flow-header">예약 발송 전용 흐름</div>
        <div class="code-block">
[공지 등록 시]
  - NoticeSendPlan (SCHEDULED, scheduledSendAt) 저장
        |
        v
[승인 시]
  - 상태만 APPROVED 로 변경
  - 메일은 아직 발송 안 함
        |
        v
[Scheduler (NoticeMailScheduler)]
  - 주기적으로 실행
  - scheduledSendAt <= 현재시간 인 계획 조회
        |
        v
[NoticeMailService.sendNoticeEmail]
        |
        v
[NoticeDeliveryLog 기록 & NoticeSendPlan 삭제]
        </div>
      </div>

      <h2>4. 캘린더 등록 플로우</h2>

      <div class="flow-box">
        <div class="flow-header">메일 발송과 별도로 동작</div>
        <div class="code-block">
[승인 시]
  if (calendarRegister == true && calendarEventAt != null) {
      OutlookCalendarService.createCalendarEvent(...)
  }

[OutlookCalendarService]
  - 이벤트 제목/내용/참석자 구성
  - Graph API 로 /events 생성
  - 응답 eventId 를 NoticeCalendarEvent 테이블에 저장
        </div>
      </div>

      <h2>5. 파일/클래스 기준 요약</h2>

      <div class="flow-box">
        <div class="flow-header">주요 파일 · 책임</div>
        <table class="table-like">
          <thead>
            <tr>
              <th>레이어</th>
              <th>클래스</th>
              <th>핵심 역할</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Controller</td>
              <td><span class="code">NoticeController</span></td>
              <td>공지 등록, 조회, 승인 API 진입점</td>
            </tr>
            <tr>
              <td>Service</td>
              <td><span class="code">NoticeService</span></td>
              <td>공지 상태 관리, 승인 로직, 발송 계획 처리</td>
            </tr>
            <tr>
              <td>Service</td>
              <td><span class="code">NoticeMailService</span></td>
              <td>실제 메일 내용 생성 및 발송, 발송 로그 기록</td>
            </tr>
            <tr>
              <td>Scheduler</td>
              <td><span class="code">NoticeMailScheduler</span></td>
              <td>예약 공지의 발송 시점 도래 여부 확인 및 메일 발송</td>
            </tr>
            <tr>
              <td>Service</td>
              <td><span class="code">OutlookCalendarService</span></td>
              <td>Outlook 캘린더 이벤트 생성, eventId 저장</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2>6. 한 줄 요약</h2>

      <div class="flow-box">
        <div class="flow-header">전체 한 줄로 정리하면</div>
        <p style="font-size: 13px; margin: 0;">
          <span class="highlight">공지 등록</span> 시 공지 + 발송계획만 저장하고<br/>
          <span class="highlight">승인 시점</span>에<br/>
          <strong>즉시 발송이면 바로 메일</strong>,<br/>
          <strong>예약 발송이면 스케줄러가 시간 맞춰 메일</strong>,<br/>
          <strong>캘린더 체크되어 있으면 그때 Outlook 이벤트 생성</strong>이라고 보면 됩니다.
        </p>
      </div>
    </div>
  </div>

  <div class="footer">
    문서 버전: v1 · 생성 형식: HTML 요약 · 신뢰도(구현 코드 기반 정리 기준): 약 95%
  </div>
</body>
</html>
