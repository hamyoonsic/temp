# 📧 공지 발송 전체 흐름 및 테스트 가이드

## 🎯 발송 모드 3가지

### 1️⃣ 즉시 발송 (IMMEDIATE) ⚡

**동작 방식:**
```
사용자가 공지 등록 (sendMode: IMMEDIATE)
→ 관리자 승인
→ 🚀 즉시 메일 발송!
```

**코드 흐름:**
```java
// NoticeService_Final.java - approveNotice() 메서드
public void approveNotice(Long noticeId, String approver) {
    notice.setNoticeStatus("APPROVED");
    
    // ✅ 즉시 발송 모드 체크
    sendPlanRepository.findByNoticeId(noticeId).ifPresent(plan -> {
        if ("IMMEDIATE".equals(plan.getSendMode())) {
            log.info("🚀 즉시 발송 모드 - 메일 발송 시작");
            mailService.sendNoticeEmail(noticeId);  // 👈 여기서 바로 발송!
        }
    });
}
```

**특징:**
- ✅ 승인 즉시 발송
- ✅ 대기 시간 없음
- ✅ 긴급 공지에 적합

---

### 2️⃣ 정기 발송 (SCHEDULED - 시간대) 📅

**발송 시간:**
- 🌅 **오전 정기발송**: 매일 09:00 (KST)
- 🌞 **오후 정기발송 1**: 매일 13:00 (KST)
- 🌆 **오후 정기발송 2**: 매일 17:00 (KST)

**동작 방식:**
```
사용자가 공지 등록 (sendMode: SCHEDULED, scheduledSendAt: 2026-01-22T09:00:00)
→ 관리자 승인
→ ⏰ 09:00까지 대기
→ 스케줄러가 09:00에 자동 발송
```

**코드 흐름:**
```java
// NoticeMailScheduler.java - sendScheduledNotices()
@Scheduled(cron = "0 0 9,13,17 * * ?", zone = "Asia/Seoul")
public void sendScheduledNotices() {
    // 현재 시간대 공지 조회
    LocalDateTime now = LocalDateTime.now();
    LocalDateTime startTime = now.withSecond(0).withNano(0);
    LocalDateTime endTime = startTime.plusMinutes(1);
    
    List<NoticeSendPlan> plans = sendPlanRepository
        .findScheduledPlansInTimeRange(startTime, endTime);
    
    // 📧 일괄 발송
    for (NoticeSendPlan plan : plans) {
        mailService.sendNoticeEmail(plan.getNoticeId());
    }
}
```

**특징:**
- ✅ 정해진 시간에 일괄 발송
- ✅ 같은 시간대 공지 묶음 발송 (효율적)
- ✅ 예측 가능한 발송 시간

---

### 3️⃣ 지정 시간 발송 (SCHEDULED - 사용자 지정) ⏰

**동작 방식:**
```
사용자가 공지 등록 (sendMode: SCHEDULED, scheduledSendAt: 2026-01-22T14:30:00)
→ 관리자 승인
→ ⏰ 14:30까지 대기
→ 스케줄러가 14:30에 자동 발송
```

**특징:**
- ✅ 원하는 날짜/시간 지정
- ✅ 유연한 스케줄링
- ✅ 정기 시간대 외 발송 가능

---

## 🧪 테스트 모드 적용 (모든 발송 모드에서 동작!)

### ✅ 핵심: 모든 발송은 NoticeMailService를 거침!

```
즉시 발송 → mailService.sendNoticeEmail(noticeId)
정기 발송 → mailService.sendNoticeEmail(noticeId)
지정 시간 → mailService.sendNoticeEmail(noticeId)
             ↓
      NoticeMailService_WithTestMode
             ↓
    테스트 모드 체크 (117번 라인)
             ↓
   ┌─────────┴──────────┐
   ↓                    ↓
test-mode: true    test-mode: false
로그만 출력          실제 메일 발송
```

---

## 📋 테스트 시나리오별 가이드

### 시나리오 1: 즉시 발송 테스트 ⚡

#### Step 1: 테스트 모드 활성화
```yaml
# application.yaml
notice:
  mail:
    test-mode: true
```

#### Step 2: 공지 등록
```json
POST /v1/api/notices
{
  "title": "[테스트] 긴급 공지",
  "content": "테스트 메일입니다",
  "sendPlan": {
    "sendMode": "IMMEDIATE",
    "allowBundle": true
  }
}
```

#### Step 3: 승인
```
POST /v1/api/notices/{noticeId}/approve
```

#### Step 4: 로그 확인
```
🚀 즉시 발송 모드 - 메일 발송 시작: noticeId=1
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧪 [테스트 모드] 메일 발송 정보
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 공지 ID: 1
📋 공지 제목: [테스트] 긴급 공지
👤 발신자 (FROM): admin@company.com
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📧 수신자 (TO): 15 명
📧 수신자 목록:
   ✉️ user1@company.com
   ✉️ user2@company.com
   ... (전체 목록)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧪🧪🧪 [테스트 모드] 실제 메일은 발송되지 않았습니다 🧪🧪🧪
✅ 메일 발송 완료: noticeId=1, recipients=15
```

**결과:**
- ✅ 실제 메일 발송 안됨
- ✅ 로그로 모든 정보 확인
- ✅ 데이터베이스에는 정상 저장 (SENT 상태)

---

### 시나리오 2: 정기 발송 테스트 (09:00) 🌅

#### Step 1: 테스트 모드 활성화
```yaml
notice:
  mail:
    test-mode: true
```

#### Step 2: 공지 등록
```json
POST /v1/api/notices
{
  "title": "[테스트] 정기 공지",
  "content": "오전 9시에 발송됩니다",
  "sendPlan": {
    "sendMode": "SCHEDULED",
    "scheduledSendAt": "2026-01-22T09:00:00",
    "allowBundle": true
  }
}
```

#### Step 3: 승인
```
POST /v1/api/notices/{noticeId}/approve
```

**로그:**
```
⏰ 예약 발송 모드 - 스케줄러에서 발송 예정: noticeId=1, scheduledAt=2026-01-22T09:00:00
```

#### Step 4: 09:00 대기

#### Step 5: 09:00에 스케줄러 실행
```
⏰ 정기 발송 스케줄러 실행: 09:00
📬 발송 예정 공지 수: 1
📧 공지 발송 시작: noticeId=1, scheduledAt=2026-01-22T09:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧪 [테스트 모드] 메일 발송 정보
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
... (발송 정보 출력)
🧪🧪🧪 [테스트 모드] 실제 메일은 발송되지 않았습니다 🧪🧪🧪
✅ 정기 발송 완료: 성공=1, 실패=0, 전체=1
```

---

### 시나리오 3: 지정 시간 발송 테스트 (14:30) ⏰

#### Step 1: 공지 등록
```json
POST /v1/api/notices
{
  "title": "[테스트] 오후 2시 30분 발송",
  "sendPlan": {
    "sendMode": "SCHEDULED",
    "scheduledSendAt": "2026-01-22T14:30:00"
  }
}
```

#### Step 2: 14:30에 자동 발송
- 정기 발송과 동일하게 스케줄러가 처리
- 테스트 모드 적용

---

## 🔄 발송 모드별 비교표

| 항목 | 즉시 발송 | 정기 발송 (09/13/17) | 지정 시간 발송 |
|------|----------|---------------------|--------------|
| **발송 시점** | 승인 즉시 | 09:00/13:00/17:00 | 사용자 지정 시간 |
| **대기 시간** | 없음 | 있음 (최대 24시간) | 있음 (가변) |
| **묶음 발송** | 불가 | 가능 | 가능 |
| **용도** | 긴급 공지 | 일반 공지 | 특정 시간 공지 |
| **테스트 모드** | ✅ 적용 | ✅ 적용 | ✅ 적용 |

---

## 🛡️ 테스트 단계별 가이드

### 1단계: 즉시 발송 테스트 (완전 안전)
```yaml
notice.mail.test-mode: true
```
- 즉시 발송 공지 등록
- 승인 후 로그 확인
- 수신자 목록 확인

### 2단계: 정기 발송 테스트
```yaml
notice.mail.test-mode: true
```
- 오전 9시 발송 공지 등록
- 09:00에 스케줄러 실행 확인
- 로그로 발송 정보 확인

### 3단계: 화이트리스트 테스트
```yaml
notice.mail.test-mode: false
notice.mail.whitelist-mode: true
notice.mail.whitelist-emails:
  - your.email@company.com
```
- 본인 이메일로만 실제 발송
- 모든 발송 모드 테스트
- 메일 수신 확인

### 4단계: 실제 운영
```yaml
notice.mail.test-mode: false
notice.mail.whitelist-mode: false
```
- 모든 사용자에게 발송

---

## 📊 전체 발송 흐름도

```
┌─────────────────────────────────────────────────────────┐
│                  공지 등록 & 발송 계획                      │
│  ┌────────────┬────────────────┬────────────────────┐   │
│  │ 즉시 발송   │ 정기 발송       │ 지정 시간 발송      │   │
│  │ IMMEDIATE  │ SCHEDULED      │ SCHEDULED          │   │
│  │            │ 09:00/13:00/17 │ 사용자 지정         │   │
│  └─────┬──────┴────────┬───────┴──────────┬─────────┘   │
└────────┼───────────────┼──────────────────┼─────────────┘
         │               │                  │
         ↓               ↓                  ↓
    ┌─────────┐    ┌──────────┐      ┌──────────┐
    │ 승인 대기 │    │ 승인 대기  │      │ 승인 대기  │
    └────┬────┘    └─────┬────┘      └─────┬────┘
         │               │                  │
         ↓               ↓                  ↓
    ┌─────────┐    ┌──────────┐      ┌──────────┐
    │관리자 승인│    │관리자 승인 │      │관리자 승인 │
    └────┬────┘    └─────┬────┘      └─────┬────┘
         │               │                  │
         ↓               ↓                  ↓
    🚀 즉시 발송     ⏰ 시간 대기        ⏰ 시간 대기
         │               │                  │
         │          ┌────┴────┐        ┌────┴────┐
         │          ↓         ↓        ↓         ↓
         │       09:00    13:00    지정 시간
         │          │         │        │
         └──────────┴─────────┴────────┴──────────┐
                                                   ↓
                         NoticeMailService
                    (테스트 모드 체크 지점)
                                ↓
                    ┌───────────┴───────────┐
                    ↓                       ↓
             test-mode: true         test-mode: false
              로그만 출력               실제 메일 발송
                    ↓                       ↓
             데이터베이스 저장         데이터베이스 저장
              (SENT 상태)              (SENT 상태)
```

---

## 💡 핵심 포인트

### ✅ 1. 모든 발송은 NoticeMailService를 거침
```java
// 어디서든 발송은 항상 이 메서드 호출
mailService.sendNoticeEmail(noticeId);
```

### ✅ 2. 테스트 모드는 모든 발송에 적용
- 즉시 발송 ✅
- 정기 발송 ✅
- 지정 시간 발송 ✅

### ✅ 3. 발송 시점만 다를 뿐, 로직은 동일
```
즉시 = 승인 즉시
정기 = 09:00/13:00/17:00
지정 = 사용자가 설정한 시간
```

### ✅ 4. 스케줄러는 이중 안전장치
```java
// 승인 시 즉시 발송 (주 발송)
approveNotice() → mailService.sendNoticeEmail()

// 스케줄러도 체크 (보조 발송, 만약을 위한 안전장치)
@Scheduled(cron = "0 * * * * ?")
sendImmediateNotices() → mailService.sendNoticeEmail()
```

---

## 🎯 테스트 체크리스트

### 즉시 발송
- [ ] test-mode: true 설정
- [ ] 공지 등록 (sendMode: IMMEDIATE)
- [ ] 승인
- [ ] 로그에서 발송 정보 확인
- [ ] 수신자 목록 확인
- [ ] 첨부파일 확인

### 정기 발송 (09:00)
- [ ] 공지 등록 (scheduledSendAt: 09:00)
- [ ] 승인
- [ ] 09:00까지 대기
- [ ] 스케줄러 실행 로그 확인
- [ ] 발송 정보 확인

### 지정 시간 발송
- [ ] 공지 등록 (원하는 시간 지정)
- [ ] 승인
- [ ] 지정 시간까지 대기
- [ ] 발송 확인

### 실제 운영 전
- [ ] 화이트리스트로 본인에게만 테스트
- [ ] 모든 발송 모드 검증
- [ ] 첨부파일 다운로드 확인
- [ ] 메일 포맷 확인

---

## 🆘 FAQ

### Q1: 즉시 발송은 몇 초 후에 발송되나요?
**A:** 승인 버튼 클릭 즉시 발송됩니다. (1초 이내)

### Q2: 정기 발송은 정확히 09:00에 발송되나요?
**A:** 네, Cron 표현식 `0 0 9 * * ?`로 정확히 09:00:00에 실행됩니다.

### Q3: 14:30 같은 중간 시간도 가능한가요?
**A:** 네, 지정 시간 발송으로 가능합니다. 스케줄러가 매 분마다 체크합니다.

### Q4: 테스트 모드에서도 데이터베이스에 저장되나요?
**A:** 네, 발송 이력과 수신자 기록은 정상적으로 저장됩니다. (메일만 안 나감)

### Q5: 한 공지를 여러 발송 모드로 보낼 수 있나요?
**A:** 아니요, 공지 하나당 발송 모드는 하나입니다.

---

## 🚀 이제 안심하고 테스트하세요!

1. **즉시 발송**: 긴급 공지용 ⚡
2. **정기 발송**: 일반 공지용 (09/13/17시) 📅
3. **지정 시간**: 특정 시간 공지용 ⏰

**모든 발송 모드에서 테스트 모드가 작동합니다!** 🛡️
